-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.audit_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  action character varying NOT NULL,
  entity_type character varying,
  entity_id uuid,
  old_data jsonb,
  new_data jsonb,
  ip_address inet,
  user_agent text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT audit_logs_pkey PRIMARY KEY (id),
  CONSTRAINT audit_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id)
);
CREATE TABLE public.carrier_bookings (
  id uuid NOT NULL,
  booking_number character varying NOT NULL UNIQUE,
  carrier character varying NOT NULL,
  origin character varying NOT NULL,
  destination character varying NOT NULL,
  container_type character varying,
  quantity integer,
  status character varying,
  vessel character varying,
  etd date,
  metadata jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone,
  CONSTRAINT carrier_bookings_pkey PRIMARY KEY (id)
);
CREATE TABLE public.customs_entries (
  id uuid NOT NULL,
  shipment_id uuid NOT NULL,
  entry_type USER-DEFINED NOT NULL,
  reference_id character varying,
  status character varying,
  document_id uuid,
  metadata jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone,
  CONSTRAINT customs_entries_pkey PRIMARY KEY (id),
  CONSTRAINT customs_entries_shipment_id_fkey FOREIGN KEY (shipment_id) REFERENCES public.shipments(id),
  CONSTRAINT customs_entries_document_id_fkey FOREIGN KEY (document_id) REFERENCES public.documents(id)
);
CREATE TABLE public.documents (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  shipment_id uuid NOT NULL,
  uploaded_by uuid NOT NULL,
  type character varying NOT NULL CHECK (type::text = ANY (ARRAY['invoice'::character varying, 'packing_list'::character varying, 'commercial_invoice'::character varying, 'certificate_of_origin'::character varying, 'bill_of_lading'::character varying, 'house_bl'::character varying, 'master_bl'::character varying, 'telex_release'::character varying, 'other'::character varying]::text[])),
  file_name character varying NOT NULL,
  file_url character varying NOT NULL,
  file_size integer,
  mime_type character varying,
  extracted_data jsonb,
  confidence_score numeric DEFAULT 0,
  extraction_method character varying,
  needs_review boolean DEFAULT true,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT documents_pkey PRIMARY KEY (id),
  CONSTRAINT documents_shipment_id_fkey FOREIGN KEY (shipment_id) REFERENCES public.shipments(id),
  CONSTRAINT documents_uploaded_by_fkey FOREIGN KEY (uploaded_by) REFERENCES public.user_profiles(id)
);
CREATE TABLE public.extraction_jobs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  document_id uuid NOT NULL UNIQUE,
  status character varying DEFAULT 'pending'::character varying CHECK (status::text = ANY (ARRAY['pending'::character varying, 'processing'::character varying, 'completed'::character varying, 'failed'::character varying]::text[])),
  attempts integer DEFAULT 0,
  error_message text,
  model_used character varying,
  processing_time_ms integer,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT extraction_jobs_pkey PRIMARY KEY (id),
  CONSTRAINT extraction_jobs_document_id_fkey FOREIGN KEY (document_id) REFERENCES public.documents(id)
);
CREATE TABLE public.notifications (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  type character varying CHECK (type::text = ANY (ARRAY['quote'::character varying, 'status'::character varying, 'document'::character varying, 'system'::character varying]::text[])),
  title character varying NOT NULL,
  message text NOT NULL,
  data jsonb DEFAULT '{}'::jsonb,
  is_read boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  read_at timestamp with time zone,
  CONSTRAINT notifications_pkey PRIMARY KEY (id),
  CONSTRAINT notifications_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id)
);
CREATE TABLE public.payment_transactions (
  transaction_id uuid NOT NULL DEFAULT gen_random_uuid(),
  payment_id uuid NOT NULL,
  gateway text NOT NULL DEFAULT 'razorpay_mock'::text,
  gateway_transaction_id text,
  amount numeric NOT NULL,
  status text NOT NULL CHECK (status = ANY (ARRAY['pending'::text, 'success'::text, 'failed'::text])),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT payment_transactions_pkey PRIMARY KEY (transaction_id),
  CONSTRAINT payment_transactions_payment_id_fkey FOREIGN KEY (payment_id) REFERENCES public.payments(payment_id)
);
CREATE TABLE public.payments (
  payment_id uuid NOT NULL DEFAULT gen_random_uuid(),
  shipment_id uuid NOT NULL,
  total_amount numeric NOT NULL,
  status text NOT NULL CHECK (status = ANY (ARRAY['initiated'::text, 'escrow_active'::text, 'completed'::text])),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT payments_pkey PRIMARY KEY (payment_id)
);
CREATE TABLE public.quotes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  shipment_id uuid NOT NULL,
  forwarder_id uuid NOT NULL,
  freight_amount_usd numeric NOT NULL,
  fuel_surcharge numeric DEFAULT 0,
  thc_charges numeric DEFAULT 0,
  documentation_charges numeric DEFAULT 0,
  other_charges numeric DEFAULT 0,
  total_amount_usd numeric NOT NULL,
  validity_date timestamp with time zone NOT NULL,
  transit_time_days integer NOT NULL,
  free_days_at_destination integer DEFAULT 7,
  routing text NOT NULL,
  vessel_name character varying,
  voyage_number character varying,
  container_type character varying,
  container_quantity integer DEFAULT 1,
  status character varying DEFAULT 'pending'::character varying CHECK (status::text = ANY (ARRAY['pending'::character varying, 'accepted'::character varying, 'rejected'::character varying, 'expired'::character varying]::text[])),
  remarks text,
  terms_and_conditions text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  metadata jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT quotes_pkey PRIMARY KEY (id),
  CONSTRAINT quotes_shipment_id_fkey FOREIGN KEY (shipment_id) REFERENCES public.shipments(id),
  CONSTRAINT quotes_forwarder_id_fkey FOREIGN KEY (forwarder_id) REFERENCES public.user_profiles(id)
);
CREATE TABLE public.shipments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  shipment_number character varying NOT NULL UNIQUE,
  supplier_id uuid NOT NULL,
  buyer_id uuid,
  origin_port character varying NOT NULL,
  destination_port character varying NOT NULL,
  incoterm character varying CHECK (incoterm::text = ANY (ARRAY['FOB'::character varying, 'CIF'::character varying, 'CFR'::character varying, 'EXW'::character varying, 'DAP'::character varying, 'DDP'::character varying]::text[])),
  cargo_type character varying CHECK (cargo_type::text = ANY (ARRAY['FCL'::character varying, 'LCL'::character varying, 'AIR'::character varying, 'BREAKBULK'::character varying]::text[])),
  container_type character varying,
  container_qty integer DEFAULT 1,
  goods_description text NOT NULL,
  hs_code character varying,
  gross_weight_kg numeric,
  net_weight_kg numeric,
  volume_cbm numeric,
  total_packages integer,
  package_type character varying,
  preferred_etd timestamp with time zone,
  preferred_eta timestamp with time zone,
  actual_etd timestamp with time zone,
  actual_eta timestamp with time zone,
  status character varying DEFAULT 'draft'::character varying CHECK (status::text = ANY (ARRAY['draft'::character varying, 'pending_quote'::character varying, 'quoted'::character varying, 'booked'::character varying, 'in_transit'::character varying, 'arrived'::character varying, 'delivered'::character varying, 'cancelled'::character varying]::text[])),
  declared_value_usd numeric,
  insurance_required boolean DEFAULT false,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT shipments_pkey PRIMARY KEY (id),
  CONSTRAINT shipments_supplier_id_fkey FOREIGN KEY (supplier_id) REFERENCES public.user_profiles(id),
  CONSTRAINT shipments_buyer_id_fkey FOREIGN KEY (buyer_id) REFERENCES public.user_profiles(id)
);
CREATE TABLE public.tracking_events (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  shipment_id uuid NOT NULL,
  created_by uuid,
  status character varying NOT NULL,
  location character varying,
  vessel_name character varying,
  voyage_number character varying,
  container_number character varying,
  description text NOT NULL,
  remarks text,
  estimated_datetime timestamp with time zone,
  actual_datetime timestamp with time zone DEFAULT now(),
  documents jsonb DEFAULT '[]'::jsonb,
  is_milestone boolean DEFAULT false,
  verified boolean DEFAULT false,
  timestamp timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT tracking_events_pkey PRIMARY KEY (id),
  CONSTRAINT tracking_events_shipment_id_fkey FOREIGN KEY (shipment_id) REFERENCES public.shipments(id),
  CONSTRAINT tracking_events_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id)
);
CREATE TABLE public.user_profiles (
  id uuid NOT NULL,
  name character varying NOT NULL,
  company_name character varying,
  phone character varying,
  gstin character varying,
  country character varying DEFAULT 'IN'::character varying,
  address text,
  role character varying NOT NULL CHECK (role::text = ANY (ARRAY['supplier'::character varying, 'forwarder'::character varying, 'buyer'::character varying]::text[])),
  is_verified boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  auth_uid uuid UNIQUE,
  CONSTRAINT user_profiles_pkey PRIMARY KEY (id),
  CONSTRAINT user_profiles_id_fkey FOREIGN KEY (id) REFERENCES auth.users(id),
  CONSTRAINT user_profiles_auth_uid_fkey FOREIGN KEY (auth_uid) REFERENCES auth.users(id)
);
CREATE TABLE public.users (
  id integer NOT NULL DEFAULT nextval('users_id_seq'::regclass),
  email character varying NOT NULL,
  hashed_password character varying NOT NULL,
  name character varying NOT NULL,
  company_name character varying,
  phone character varying,
  role character varying NOT NULL,
  gstin character varying,
  country character varying,
  is_verified boolean,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT users_pkey PRIMARY KEY (id)
);